<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Price Groups (Up to 4)</title>
</head>
<body>

<h1>Price Groups Viewer (Max 4 Groups)</h1>
<p id="info"></p>

<div id="groups"></div>

<script>
// ---------------- Helper: parse price ----------------
function parsePrice(priceStr) {
  return parseFloat((priceStr || "").replace(/[^\d.]/g, "")) || 0;
}

// ---------------- Main grouping function ----------------
function createPriceGroups(products, maxGroups = 4) {
  if (!products.length) return [];

  // Add numeric price
  const sorted = products.map(p => ({ ...p, numericPrice: parsePrice(p.price) }))
                         .sort((a, b) => a.numericPrice - b.numericPrice);

  const minPrice = sorted[0].numericPrice;
  const maxPrice = sorted[sorted.length - 1].numericPrice;

  // Compute price range per group
  const range = maxPrice - minPrice;
  const step = range / maxGroups;

  const groups = [];

  for (let i = 0; i < maxGroups; i++) {
    const lower = minPrice + i * step;
    const upper = i === maxGroups - 1 ? maxPrice : lower + step;
    const grpProducts = sorted.filter(p => p.numericPrice >= lower && p.numericPrice <= upper);
    if (grpProducts.length > 0) {
      groups.push({ lower, upper, products: grpProducts });
    }
  }

  return groups;
}

// ---------------- Display groups ----------------
function displayGroups(groups) {
  const container = document.getElementById("groups");
  container.innerHTML = "";

  groups.forEach((grp, idx) => {
    const groupDiv = document.createElement("div");

    const header = document.createElement("h2");
    header.textContent = `Group ${idx + 1} | Price: ${grp.lower} - ${grp.upper} | ${grp.products.length} products`;
    groupDiv.appendChild(header);

    grp.products.forEach(p => {
      const div = document.createElement("div");
      div.innerHTML = `
        <strong>${p.title}</strong><br>
        Price: ${p.price}<br>
        Source: ${p.source || "N/A"}<br>
        Link: <a href="${p.link || p.product_link || "#"}" target="_blank">view</a><br>
        Image: <a href="${p.image_url || "#"}" target="_blank">view</a>
        <hr>
      `;
      groupDiv.appendChild(div);
    });

    container.appendChild(groupDiv);
  });
}

// ---------------- Main ----------------
(function main() {
  const info = document.getElementById("info");
  const cached = localStorage.getItem("lastSearchResults");

  if (!cached) {
    info.textContent = "No lastSearchResults found in localStorage.";
    return;
  }

  let products;
  try {
    products = JSON.parse(cached);
  } catch (e) {
    info.textContent = "Cache exists but is invalid JSON.";
    console.error(e);
    return;
  }

  info.textContent = `Total products in cache: ${products.length}`;

  const groups = createPriceGroups(products, 4); // Max 4 groups
  displayGroups(groups);
})();
</script>

</body>
</html>
