<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schedule Notification</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:40px auto; padding:0 16px; color:#111; }
    h1 { font-size: 1.6rem; margin-bottom: 0.2rem; }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input[type="text"], input[type="number"], textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:1rem; }
    button { padding:10px 14px; border-radius:8px; border:0; background:#0b76ef; color:white; font-weight:600; cursor:pointer; }
    button[disabled]{opacity:0.6; cursor:default;}
    .small { font-size:0.9rem; color:#555; }
    .status { margin-top:12px; padding:12px; border-radius:8px; background:#f6f8fb; border:1px solid #e6eefc; }
    .error { color:#b00020; font-weight:600; }
    .success { color:#116622; font-weight:600; }
  </style>
</head>
<body>
  <h1>Schedule a Notification</h1>
  <p class="small">
    This version always uses the constant title <strong>Offers</strong>.  
    The message field is your product query (e.g. <em>water dispenser</em>).
  </p>

  <form id="notifyForm">
    <!-- removed title input -->
    <label for="message">Product / Query</label>
    <textarea id="message" name="message" rows="3" placeholder="E.g. water dispenser" required></textarea>

    <label for="delay">Delay (seconds)</label>
    <input id="delay" name="delay" type="number" min="0" step="1" value="30" required />

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="sendBtn" type="submit">Schedule</button>
      <button id="testBrowserBtn" type="button">Show Local Browser Notification</button>
    </div>
  </form>

  <div class="status" id="statusArea" hidden>
    <div id="statusText"></div>
    <pre id="responseRaw" style="margin-top:8px; white-space:pre-wrap; font-size:0.9rem;"></pre>
  </div>

<script>
(() => {
  const API_URL = "/notify_scheduler";
  const form = document.getElementById("notifyForm");
  const sendBtn = document.getElementById("sendBtn");
  const testBrowserBtn = document.getElementById("testBrowserBtn");
  const statusArea = document.getElementById("statusArea");
  const statusText = document.getElementById("statusText");
  const responseRaw = document.getElementById("responseRaw");
  const CONSTANT_TITLE = "Offers";   // <── constant title here

  function showStatus(text, kind = "") {
    statusArea.hidden = false;
    statusText.textContent = text;
    statusText.className = kind === "error" ? "error" :
                           (kind === "success" ? "success" : "");
  }

  async function requestNotificationPermissionOnce() {
    if (!("Notification" in window)) return false;
    if (Notification.permission === "granted") return true;
    if (Notification.permission === "denied") return false;
    const p = await Notification.requestPermission().catch(() => "denied");
    return p === "granted";
  }

  async function sendScheduleRequest(message, delay_seconds) {
    sendBtn.disabled = true;
    showStatus("Sending schedule request to server...");
    responseRaw.textContent = "";

    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: CONSTANT_TITLE, message, delay_seconds })
      });
      const data = await resp.json().catch(() => ({}));
      responseRaw.textContent = JSON.stringify({ status: resp.status, body: data }, null, 2);

      if (!resp.ok) {
        showStatus(`Server responded with error (HTTP ${resp.status}).`, "error");
      } else {
        showStatus("Server responded successfully.", "success");
        if (data.platform === "desktop" || data.status === "success") {
          const permitted = await requestNotificationPermissionOnce();
          if (permitted) {
            new Notification(CONSTANT_TITLE, { body: `(Scheduled ${delay_seconds}s) ${message}` });
          }
        }
      }
    } catch (err) {
      showStatus("Request failed — is the Flask server running?", "error");
      responseRaw.textContent = String(err);
    } finally {
      sendBtn.disabled = false;
    }
  }

  form.addEventListener("submit", async ev => {
    ev.preventDefault();
    const message = document.getElementById("message").value.trim();
    const delay = Number(document.getElementById("delay").value);
    if (!message || Number.isNaN(delay) || delay < 0) {
      showStatus("Please provide a valid message and non-negative delay.", "error");
      return;
    }
    await sendScheduleRequest(message, delay);
  });

  testBrowserBtn.addEventListener("click", async () => {
    const message = document.getElementById("message").value.trim() ||
                    "This is a local browser notification.";
    const permitted = await requestNotificationPermissionOnce();
    if (!permitted) {
      showStatus("Browser notification permission denied.", "error");
      return;
    }
    new Notification(CONSTANT_TITLE, { body: message });
    showStatus("Local browser notification shown.", "success");
  });

  if (location.protocol === "file:") {
    showStatus("Notice: Open through a server to call the API.", "error");
  }
})();
</script>
</body>
</html>
