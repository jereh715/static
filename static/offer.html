<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Send Notification</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:40px auto; padding:0 16px; color:#111; }
    h1 { font-size: 1.6rem; margin-bottom: 0.2rem; }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input[type="text"], textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:1rem; }
    button { padding:10px 14px; border-radius:8px; border:0; background:#0b76ef; color:white; font-weight:600; cursor:pointer; }
    button[disabled]{opacity:0.6; cursor:default;}
    .small { font-size:0.9rem; color:#555; }
    .status { margin-top:12px; padding:12px; border-radius:8px; background:#f6f8fb; border:1px solid #e6eefc; }
    .error { color:#b00020; font-weight:600; }
    .success { color:#116622; font-weight:600; }
    #notifContainer { margin-top: 24px; padding: 16px; background: #f9fafc; border: 1px solid #e3e9f4; border-radius: 8px; }
    #notifContainer h2 { margin-top: 0; font-size: 1.2rem; }
    pre.json-output { white-space: pre-wrap; background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 10px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Send Notification</h1>
  <p class="small">
    This version always uses the constant title <strong>Offers</strong>.  
    The message field is your product query (e.g. <em>water dispenser</em>).
  </p>

  <form id="notifyForm">
    <label for="message">Product / Query</label>
    <textarea id="message" name="message" rows="3" placeholder="E.g. water dispenser" required></textarea>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="sendBtn" type="submit">Send Notification</button>
      <button id="testBrowserBtn" type="button">Show Local Browser Notification</button>
      <button id="loadJsonBtn" type="button">Load Notification JSON</button>
    </div>
  </form>

  <div class="status" id="statusArea" hidden>
    <div id="statusText"></div>
    <pre id="responseRaw" style="margin-top:8px; white-space:pre-wrap; font-size:0.9rem;"></pre>
  </div>

  <div id="notifContainer" hidden>
    <h2>📦 Cached Notifications JSON</h2>
    <pre id="notifJson" class="json-output"></pre>
  </div>

<script>
(() => {
  const API_URL = "/notify_scheduler";
  const JSON_URL = "/api/notifications";
  const form = document.getElementById("notifyForm");
  const sendBtn = document.getElementById("sendBtn");
  const testBrowserBtn = document.getElementById("testBrowserBtn");
  const loadJsonBtn = document.getElementById("loadJsonBtn");
  const statusArea = document.getElementById("statusArea");
  const statusText = document.getElementById("statusText");
  const responseRaw = document.getElementById("responseRaw");
  const notifContainer = document.getElementById("notifContainer");
  const notifJson = document.getElementById("notifJson");
  const CONSTANT_TITLE = "Offers";

  function showStatus(text, kind = "") {
    statusArea.hidden = false;
    statusText.textContent = text;
    statusText.className = kind === "error" ? "error" :
                           (kind === "success" ? "success" : "");
  }

  async function requestNotificationPermissionOnce() {
    if (!("Notification" in window)) return false;
    if (Notification.permission === "granted") return true;
    if (Notification.permission === "denied") return false;
    const p = await Notification.requestPermission().catch(() => "denied");
    return p === "granted";
  }

  async function sendNotificationRequest(message) {
    sendBtn.disabled = true;
    showStatus("Sending notification request to server...");
    responseRaw.textContent = "";

    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: CONSTANT_TITLE, message })
      });

      const data = await resp.json().catch(() => ({}));
      responseRaw.textContent = JSON.stringify({ status: resp.status, body: data }, null, 2);

      if (!resp.ok) {
        showStatus(`Server responded with error (HTTP ${resp.status}).`, "error");
      } else {
        showStatus("Server responded successfully.", "success");
        const permitted = await requestNotificationPermissionOnce();
        if (permitted) {
          new Notification(CONSTANT_TITLE, { body: message });
        }
      }
    } catch (err) {
      showStatus("Request failed — is the Flask server running?", "error");
      responseRaw.textContent = String(err);
    } finally {
      sendBtn.disabled = false;
    }
  }

  async function loadNotificationJson() {
    notifContainer.hidden = false;
    notifJson.textContent = "⏳ Loading notification JSON...";
    try {
      const resp = await fetch(JSON_URL);
      const data = await resp.json();
      notifJson.textContent = JSON.stringify(data, null, 2);
      showStatus("Loaded notification JSON successfully.", "success");
    } catch (err) {
      notifJson.textContent = "❌ Failed to load notification JSON:\n" + err;
      showStatus("Failed to load notification JSON.", "error");
    }
  }

  form.addEventListener("submit", async ev => {
    ev.preventDefault();
    const message = document.getElementById("message").value.trim();
    if (!message) {
      showStatus("Please provide a message.", "error");
      return;
    }
    await sendNotificationRequest(message);
  });

  testBrowserBtn.addEventListener("click", async () => {
    const message = document.getElementById("message").value.trim() ||
                    "This is a local browser notification.";
    const permitted = await requestNotificationPermissionOnce();
    if (!permitted) {
      showStatus("Browser notification permission denied.", "error");
      return;
    }
    new Notification(CONSTANT_TITLE, { body: message });
    showStatus("Local browser notification shown.", "success");
  });

  loadJsonBtn.addEventListener("click", loadNotificationJson);

  if (location.protocol === "file:") {
    showStatus("Notice: Open through a server to call the API.", "error");
  }
})();
</script>
</body>
</html>
