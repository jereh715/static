<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schedule Notification</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 24px; max-width: 640px; margin: auto; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea, button { font-size: 16px; padding:8px; width:100%; box-sizing: border-box; margin-top:6px; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .small { width:150px; }
    .hint { color:#666; font-size:13px; margin-top:6px; }
    .result { margin-top:14px; padding:10px; border-radius:6px; }
    .ok { background:#e6ffed; border:1px solid #9be6b7; color:#0a5b2d; }
    .err { background:#ffecec; border:1px solid #f1a0a0; color:#7a1a1a; }
  </style>
</head>
<body>
  <h1>Schedule Notification</h1>

  <form id="notifyForm">
    <label for="title">Title</label>
    <input id="title" name="title" type="text" placeholder="Meeting reminder" required />

    <label for="message">Message</label>
    <textarea id="message" name="message" rows="4" placeholder="Don't forget the meeting at 3pm" required></textarea>

    <label>Schedule</label>
    <div class="row">
      <div>
        <label for="datetime">Exact date &amp; time (local)</label>
        <input id="datetime" type="datetime-local" />
        <div class="hint">Choose a date/time â€” the page will compute seconds until that time.</div>
      </div>

      <div>
        <label for="delay">OR delay (seconds)</label>
        <input id="delay" type="number" min="1" placeholder="30" />
        <div class="hint">If both are provided, exact date/time wins.</div>
      </div>
    </div>

    <label for="notificationId">(optional) Notification ID label</label>
    <input id="notificationId" type="text" placeholder="reminder-1 (for your reference)" />

    <div style="margin-top:14px;">
      <button id="sendBtn" type="submit">Schedule Notification</button>
    </div>

    <div id="resultArea" class="result" style="display:none;"></div>
  </form>

  <script>
    (function () {
      const form = document.getElementById('notifyForm');
      const titleEl = document.getElementById('title');
      const msgEl = document.getElementById('message');
      const datetimeEl = document.getElementById('datetime');
      const delayEl = document.getElementById('delay');
      const resultArea = document.getElementById('resultArea');
      const sendBtn = document.getElementById('sendBtn');

      function showResult(ok, text) {
        resultArea.style.display = 'block';
        resultArea.className = ok ? 'result ok' : 'result err';
        resultArea.textContent = text;
      }

      function computeDelaySeconds() {
        // If datetime provided, compute seconds until that time (local)
        const dt = datetimeEl.value;
        if (dt) {
          const target = new Date(dt);
          const now = new Date();
          const diffMs = target - now;
          return Math.max(0, Math.round(diffMs / 1000));
        }
        // else use numeric delay
        const d = parseFloat(delayEl.value);
        if (!isNaN(d) && d > 0) return Math.round(d);
        return null;
      }

      form.addEventListener('submit', async function (ev) {
        ev.preventDefault();
        resultArea.style.display = 'none';

        const title = titleEl.value.trim();
        const message = msgEl.value.trim();
        if (!title || !message) {
          showResult(false, 'Please provide both title and message.');
          return;
        }

        const delaySeconds = computeDelaySeconds();
        if (delaySeconds === null) {
          showResult(false, 'Please provide a valid delay (seconds) or an exact date/time.');
          return;
        }
        if (delaySeconds < 1) {
          showResult(false, 'Chosen time is in the past or too close. Pick a later time or positive delay.');
          return;
        }

        const payload = {
          title: title,
          message: message,
          delay_seconds: delaySeconds
        };

        // Optional debugging field
        const notifLabel = document.getElementById('notificationId').value.trim();
        if (notifLabel) payload.client_id = notifLabel;

        try {
          sendBtn.disabled = true;
          sendBtn.textContent = 'Scheduling...';

          const resp = await fetch('/notify_scheduler', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await resp.json().catch(() => null);

          if (!resp.ok) {
            const msg = (data && data.message) ? data.message : `HTTP ${resp.status}`;
            showResult(false, 'Server error: ' + msg);
          } else {
            showResult(true, 'Scheduled: ' + JSON.stringify(data));
          }
        } catch (err) {
          showResult(false, 'Network error: ' + err.message);
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = 'Schedule Notification';
        }
      });
    })();
  </script>
</body>
</html>
