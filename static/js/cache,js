// spinner-cache-popup.js
(function () {
  console.log("Spinner cache watcher loaded");

  function getCachedProductsCount() {
    try {
      const data = JSON.parse(localStorage.getItem("lastSearchResults") || "[]");
      return Array.isArray(data) ? data.length : 0;
    } catch {
      return 0;
    }
  }

  function showCachePopup(count) {
    let container = document.getElementById("popupContainer");
    if (!container) {
      // create if missing (safety)
      container = document.createElement("div");
      container.id = "popupContainer";
      document.body.appendChild(container);
    }

    // remove any old popup of this type
    const existing = container.querySelector(".popupMessage.cache");
    if (existing) existing.remove();

    const popup = document.createElement("div");
    popup.className = "popupMessage cache";
    popup.textContent = `${count} product${count !== 1 ? "s" : ""} in cache`;

    // ensure visible
    popup.style.zIndex = "9999";
    popup.style.background = "#222";
    popup.style.color = "#fff";
    popup.style.padding = "8px 12px";
    popup.style.borderRadius = "8px";
    popup.style.position = "fixed";
    popup.style.bottom = "10px";
    popup.style.right = "10px";
    popup.style.fontSize = "14px";
    popup.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
    popup.style.transition = "opacity 0.3s";
    popup.style.opacity = "1";

    container.appendChild(popup);

    setTimeout(() => {
      popup.style.opacity = "0";
      setTimeout(() => popup.remove(), 400);
    }, 2000);
  }

  document.addEventListener("spinnerChange", (e) => {
    const { visible } = e.detail;
    console.log("Spinner visibility changed:", visible);

    if (visible) {
      // Start polling cache count
      if (!window.cacheWatcher) {
        window.cacheWatcher = setInterval(() => {
          const count = getCachedProductsCount();
          if (count > 0) {
            console.log(`ðŸŸ¢ ${count} products in cache`);
            showCachePopup(count);
          }
        }, 2000);
      }
    } else {
      // Stop polling
      if (window.cacheWatcher) {
        clearInterval(window.cacheWatcher);
        window.cacheWatcher = null;
      }
    }
  });
})();
